<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Task Manager</title>

  <style>
    :root{
      --bg: #0b1020;
      --panel: rgba(255,255,255,0.08);
      --card: rgba(255,255,255,0.10);
      --border: rgba(255,255,255,0.12);
      --text: #e8edf7;
      --muted: rgba(232,237,247,0.70);

      --primary: #7c3aed;
      --primary2: #2563eb;

      --danger: #ef4444;
      --danger2: #dc2626;

      --ok: #22c55e;
      --warn: #f59e0b;

      --shadow: 0 18px 50px rgba(0,0,0,0.35);
      --shadow2: 0 10px 30px rgba(0,0,0,0.25);
      --r: 18px;
      --r2: 14px;
    }

    *{ box-sizing: border-box; }
    body{
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--text);
      min-height: 100vh;
      background:
        radial-gradient(1000px 700px at 10% 0%, rgba(124,58,237,0.30), transparent 60%),
        radial-gradient(1000px 700px at 90% 10%, rgba(37,99,235,0.26), transparent 60%),
        radial-gradient(800px 600px at 50% 100%, rgba(34,197,94,0.10), transparent 60%),
        var(--bg);
    }

    .wrap{
      max-width: 980px;
      margin: 44px auto;
      padding: 0 16px 30px;
    }

    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 14px;
      margin-bottom: 18px;
    }

    .brand{
      display:grid;
      gap: 6px;
    }

    h1{
      margin: 0;
      font-size: 30px;
      letter-spacing: -0.02em;
    }

    .sub{
      margin: 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      max-width: 560px;
    }

    .statusPill{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      box-shadow: var(--shadow2);
      user-select:none;
      white-space: nowrap;
      font-size: 13px;
      color: var(--muted);
    }
    .dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.35);
      box-shadow: 0 0 0 3px rgba(255,255,255,0.08);
    }
    .dot.ok{ background: var(--ok); box-shadow: 0 0 0 3px rgba(34,197,94,0.18); }
    .dot.warn{ background: var(--warn); box-shadow: 0 0 0 3px rgba(245,158,11,0.18); }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1.4fr;
      gap: 16px;
    }

    .panel{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .panelHeader{
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background: rgba(255,255,255,0.05);
    }

    .panelHeader h2{
      margin:0;
      font-size: 14px;
      letter-spacing: -0.01em;
      color: rgba(232,237,247,0.90);
    }

    .panelBody{
      padding: 14px 16px 16px;
    }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    input{
      width: 100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(15,23,42,0.35);
      color: var(--text);
      outline: none;
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }

    input:focus{
      border-color: rgba(124,58,237,0.55);
      box-shadow: 0 0 0 4px rgba(124,58,237,0.18);
      background: rgba(15,23,42,0.45);
    }

    .btn{
      border:0;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 650;
      cursor:pointer;
      transition: transform .05s ease, opacity .15s ease, background .15s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }

    .btnPrimary{
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      color: white;
    }
    .btnPrimary:hover{ opacity: .92; }

    .btnGhost{
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      color: var(--text);
    }
    .btnGhost:hover{ background: rgba(255,255,255,0.09); }

    .btnDanger{
      background: rgba(239,68,68,0.12);
      border: 1px solid rgba(239,68,68,0.30);
      color: rgba(255,255,255,0.92);
    }
    .btnDanger:hover{ background: rgba(239,68,68,0.16); }

    .btnSmall{
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 650;
    }

    .actions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    .hint{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    /* Tasks area */
    .topBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    .createRow{
      display:flex;
      gap: 10px;
      margin-top: 10px;
    }
    .createRow input{ flex: 1; }
    .createRow button{ width: 140px; }

    .filters{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chip{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: rgba(232,237,247,0.90);
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{
      background: rgba(124,58,237,0.22);
      border-color: rgba(124,58,237,0.45);
    }

    .list{
      margin-top: 12px;
      display:grid;
      gap: 10px;
      max-height: 520px;
      overflow:auto;
      padding-right: 4px;
    }

    .item{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      border-radius: var(--r2);
      padding: 12px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }

    .left{
      display:flex;
      gap: 10px;
      min-width: 0;
      flex: 1;
    }

    .check{
      transform: translateY(2px);
      width: 18px;
      height: 18px;
      cursor:pointer;
    }

    .textBlock{
      min-width: 0;
      flex: 1;
      display:grid;
      gap: 6px;
    }

    .title{
      font-weight: 700;
      line-height: 1.25;
      font-size: 14px;
      /* importante: n√£o corta */
      white-space: normal;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    .meta{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }

    .badge{
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: rgba(232,237,247,0.90);
      user-select:none;
    }
    .badge.ok{
      border-color: rgba(34,197,94,0.35);
      background: rgba(34,197,94,0.12);
    }
    .badge.open{
      border-color: rgba(245,158,11,0.35);
      background: rgba(245,158,11,0.12);
    }

    .item.done .title{
      text-decoration: line-through;
      color: rgba(232,237,247,0.70);
      font-weight: 650;
    }

    .right{
      display:flex;
      gap: 8px;
      align-items:center;
    }

    .empty{
      text-align:center;
      color: var(--muted);
      border: 1px dashed rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.04);
      border-radius: var(--r2);
      padding: 18px 12px;
    }

    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
      header{ flex-direction: column; align-items: flex-start; }
      .createRow button{ width: 120px; }
      .row2, .actions{ grid-template-columns: 1fr; }
      .list{ max-height: 420px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>Task Manager</h1>
        <p class="sub">Interface de acesso a Tasks.</p>
      </div>
      <div class="statusPill">
        <span class="dot warn" id="authDot"></span>
        <span id="authStatus">desconectado</span>
      </div>
    </header>

    <div class="grid">

      <!-- AUTH -->
      <section class="panel">
        <div class="panelHeader">
          <h2>Conta</h2>
          <button class="btn btnGhost btnSmall" onclick="logout()">Sair</button>
        </div>

        <div class="panelBody">
          <div class="row2">
            <div>
              <label for="username">Usu√°rio</label>
              <input id="username" placeholder="Login" autocomplete="username" />
            </div>
            <div>
              <label for="password">Senha</label>
              <input id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" type="password" autocomplete="current-password" />
            </div>
          </div>

          <div class="actions">
            <button class="btn btnGhost" onclick="register()">Criar conta</button>
            <button class="btn btnPrimary" onclick="login()">Entrar</button>
          </div>

          <div class="hint">
            <span>Token fica salvo no navegador.</span>
            <span class="muted">Local: localStorage</span>
          </div>
        </div>
      </section>

      <!-- TASKS -->
      <section class="panel">
        <div class="panelHeader">
          <div class="topBar" style="width:100%;">
            <h2>Minhas tasks</h2>
            <button class="btn btnGhost btnSmall" onclick="loadTasks()">Atualizar</button>
          </div>
        </div>

        <div class="panelBody">
          <div class="createRow">
            <input id="title" placeholder="Digite uma task bem grande aqui‚Ä¶ (n√£o vai cortar)" />
            <button class="btn btnPrimary" onclick="createTask()">Criar</button>
          </div>

          <div class="hint" style="margin-top:12px;">
            <div class="filters">
              <span class="chip active" id="f_all" onclick="setFilter('all')">Todas</span>
              <span class="chip" id="f_open" onclick="setFilter('open')">Abertas</span>
              <span class="chip" id="f_done" onclick="setFilter('done')">Conclu√≠das</span>
            </div>
            <span class="muted" id="countInfo">0 tasks</span>
          </div>

          <div class="list" id="tasks"></div>
        </div>
      </section>

    </div>
  </div>

  <script>
    const API = "";
    let token = localStorage.getItem("token") || "";
    let currentFilter = "all"; // all | open | done

    function setAuthUI(isLogged){
      const dot = document.getElementById("authDot");
      const status = document.getElementById("authStatus");
      if(isLogged){
        dot.classList.remove("warn"); dot.classList.add("ok");
        status.textContent = "logado";
      }else{
        dot.classList.remove("ok"); dot.classList.add("warn");
        status.textContent = "desconectado";
      }
    }

    function authHeaders() {
      if (!token) return {};
      return { "Authorization": "Bearer " + token };
    }

    function logout(){
      token = "";
      localStorage.removeItem("token");
      setAuthUI(false);
      renderEmpty("Fa√ßa login para ver suas tasks.");
      updateCount([]);
    }

    function setFilter(f){
      currentFilter = f;
      document.getElementById("f_all").classList.toggle("active", f === "all");
      document.getElementById("f_open").classList.toggle("active", f === "open");
      document.getElementById("f_done").classList.toggle("active", f === "done");
      loadTasks();
    }

    function updateCount(tasks){
      const total = tasks.length;
      const open = tasks.filter(t => !t.done).length;
      const done = tasks.filter(t => t.done).length;

      let label = `${total} task(s) ‚Ä¢ ${open} abertas ‚Ä¢ ${done} conclu√≠das`;
      document.getElementById("countInfo").textContent = label;
    }

    function renderEmpty(msg){
      const container = document.getElementById("tasks");
      container.innerHTML = `<div class="empty">${escapeHtml(msg)}</div>`;
    }

    async function register() {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value;

      const res = await fetch(API + "/auth/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) return alert("Erro: " + (data.error || JSON.stringify(data)));
      alert("Usu√°rio criado! Agora clique em Entrar.");
    }

    async function login() {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value;

      const res = await fetch(API + "/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) return alert("Erro: " + (data.error || JSON.stringify(data)));

      token = data.access_token;
      localStorage.setItem("token", token);
      setAuthUI(true);
      loadTasks();
    }

    async function createTask() {
      if (!token) return alert("Fa√ßa login primeiro.");
      const titleEl = document.getElementById("title");
      const title = (titleEl.value || "").trim();
      if(!title) return alert("Digite um t√≠tulo.");

      const res = await fetch(API + "/tasks/", {
        method: "POST",
        headers: { "Content-Type": "application/json", ...authHeaders() },
        body: JSON.stringify({ title })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) return alert("Erro: " + (data.error || JSON.stringify(data)));

      titleEl.value = "";
      loadTasks();
    }

    async function loadTasks() {
      if (!token) return renderEmpty("Fa√ßa login para ver suas tasks.");

      const res = await fetch(API + "/tasks/", { headers: { ...authHeaders() } });
      const tasks = await res.json().catch(() => ([]));
      if (!res.ok) return alert("Erro: " + (tasks.error || JSON.stringify(tasks)));

      updateCount(tasks);

      let filtered = tasks;
      if(currentFilter === "open") filtered = tasks.filter(t => !t.done);
      if(currentFilter === "done") filtered = tasks.filter(t => t.done);

      const container = document.getElementById("tasks");
      container.innerHTML = "";

      if (!filtered.length){
        const msg = currentFilter === "all" ? "Nenhuma task ainda. Crie a primeira üôÇ"
                  : currentFilter === "open" ? "Nenhuma task aberta."
                  : "Nenhuma task conclu√≠da.";
        return renderEmpty(msg);
      }

      filtered.forEach(t => {
        const div = document.createElement("div");
        div.className = "item " + (t.done ? "done" : "");
        div.innerHTML = `
          <div class="left">
            <input class="check" type="checkbox" ${t.done ? "checked" : ""} onchange="toggleDone(${t.id}, this.checked)" />
            <div class="textBlock">
              <div class="title">${escapeHtml(t.title)}</div>
              <div class="meta">
                <span class="badge ${t.done ? "ok" : "open"}">${t.done ? "Conclu√≠da" : "Aberta"}</span>
                <span class="muted">ID #${t.id}</span>
              </div>
            </div>
          </div>
          <div class="right">
            <button class="btn btnDanger btnSmall" onclick="delTask(${t.id})">Deletar</button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    async function toggleDone(id, done) {
      const res = await fetch(API + "/tasks/" + id, {
        method: "PATCH",
        headers: { "Content-Type": "application/json", ...authHeaders() },
        body: JSON.stringify({ done })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) return alert("Erro: " + (data.error || JSON.stringify(data)));
      loadTasks();
    }

    async function delTask(id) {
      const ok = confirm("Tem certeza que deseja deletar?");
      if(!ok) return;

      const res = await fetch(API + "/tasks/" + id, {
        method: "DELETE",
        headers: { ...authHeaders() }
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) return alert("Erro: " + (data.error || JSON.stringify(data)));
      loadTasks();
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // init
    setAuthUI(!!token);
    if(token) loadTasks();
    else renderEmpty("Fa√ßa login para ver suas tasks.");
  </script>
</body>
</html>
